#!/usr/bin/env ruby
require "optparse"
$: << "./lib/"
require "murdoc"

options = {}
source_type = nil

option_parser = OptionParser.new do |opts|
  opts.banner = "murdoc-strip-comments [input file]\n\nWhen no input file is provided, murdoc-strip-comments uses standard input stream."

  opts.on("-t", "--type TYPE", "Source type (html, ruby, javascript)") do |st|
    source_type = st
  end

  opts.on("--do-not-count-comment-lines") do |dncl|
    options[:do_not_count_comment_lines] = dncl
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end


end

option_parser.parse!

annotator = Murdoc::Annotator.from_file(ARGV[0] || "/dev/stdin", source_type, options)

last = 0
previous = nil
annotator.paragraphs.each_with_index do |paragraph, i|
  unless (i == 0 || previous && previous.source.empty?)
    if paragraph.annotation.split("\n").size > 1
      puts "\n" * (paragraph.starting_line - last)
    end
  end

  unless paragraph.source.empty?
    puts paragraph.source
  end

  last = paragraph.starting_line + paragraph.source.split("\n").size
  previous = paragraph
end
